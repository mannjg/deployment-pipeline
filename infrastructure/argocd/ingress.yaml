---
# ArgoCD Ingress with TLS
#
# Variables (use envsubst before applying):
#   ${ARGOCD_NAMESPACE} - ArgoCD namespace (e.g., argocd)
#   ${ARGOCD_HOST} - ArgoCD hostname (e.g., argocd.jmann.local)
#   ${CA_ISSUER} - ClusterIssuer name (e.g., alpha-ca-issuer)

apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: argocd-tls
  namespace: ${ARGOCD_NAMESPACE}
spec:
  secretName: argocd-tls
  issuerRef:
    name: ${CA_ISSUER}
    kind: ClusterIssuer
  commonName: ${ARGOCD_HOST}
  dnsNames:
    - ${ARGOCD_HOST}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-server
  namespace: ${ARGOCD_NAMESPACE}
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
spec:
  ingressClassName: public
  tls:
  - hosts:
    - ${ARGOCD_HOST}
    secretName: argocd-tls
  rules:
  - host: ${ARGOCD_HOST}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: argocd-server
            port:
              number: 80
