# UC-C6: Platform Default with Environment Override

## Overview

**Use Case:** UC-C6 from `docs/USE_CASES.md`

**Story:** "Platform sets `cost-center=platform-shared` as the default for chargeback reporting, but prod needs `cost-center=production-critical` for priority billing."

**What This Validates:**
- Full CUE override hierarchy: Platform → App → Env
- Environment-specific overrides don't leak to other environments
- Platform-wide changes propagate correctly before override is applied
- Environment isolation: changing prod doesn't affect dev/stage

## Expected Outcome

| Environment | Label Value |
|-------------|-------------|
| dev | `cost-center: platform-shared` |
| stage | `cost-center: platform-shared` |
| prod | `cost-center: production-critical` |

## Implementation Approach

**Option B (chosen):** Platform default first, then override.

This approach demonstrates three distinct properties:
1. Platform propagation works (all envs get the default)
2. Override works (prod can change to a different value)
3. Isolation holds (prod's change doesn't leak to dev/stage)

The demo shows the full lifecycle: platform ships a default, then prod diverges.

## Demo Script Structure

### Phase 1: Setup
- Verify prerequisites (kubectl connectivity, ArgoCD apps exist)
- Load pipeline credentials
- Save original branch for cleanup

### Phase 2: Add Platform Default
- Add `"cost-center": "platform-shared"` to `services/core/app.cue` in `defaultLabels`
- Create feature branch (e.g., `uc-c6-platform-default-<timestamp>`)
- Commit CUE change only (manifests generated by pipeline)
- Push to GitLab via subtree push

### Phase 3: Promote Platform Default Through All Environments
- **Feature → dev:** Create MR, wait for pipeline, verify MR diff, merge
- Verify dev deployment has `cost-center: platform-shared`
- **dev → stage:** Wait for Jenkins promotion MR, verify, merge
- Verify stage deployment has `cost-center: platform-shared`
- **stage → prod:** Wait for Jenkins promotion MR, verify, merge
- Verify prod deployment has `cost-center: platform-shared`

### Phase 4: Checkpoint - All Environments Have Platform Default
- Cross-environment assertion: all three have `platform-shared`
- Print checkpoint message confirming UC-C1-like behavior

### Phase 5: Add Prod Override
- Create branch from prod (e.g., `uc-c6-prod-override-<timestamp>`)
- Add `"cost-center": "production-critical"` to prod's `appConfig.labels` in `env.cue`
- Push branch, create MR targeting prod
- Wait for pipeline validation (CUE vet, manifest generation)
- Verify MR diff contains expected changes
- Merge MR to prod
- Wait for ArgoCD sync

### Phase 6: Final Verification - Override Only Affects Prod
- Assert dev still has `platform-shared`
- Assert stage still has `platform-shared`
- Assert prod now has `production-critical`

### Phase 7: Summary & Cleanup
- Print summary of what was demonstrated
- Return to original branch
- Leave feature branches for reference

## CUE Implementation Details

### Change 1: Platform Default

**File:** `k8s-deployments/services/core/app.cue`

**Before:**
```cue
defaultLabels: {
    app:        appName
    deployment: appName
}
```

**After:**
```cue
defaultLabels: {
    app:           appName
    deployment:    appName
    "cost-center": "platform-shared"
}
```

### Change 2: Prod Override

**File:** `env.cue` on prod branch

**Before:**
```cue
appConfig: {
    labels: {
        environment: "prod"
        managed_by:  "argocd"
    }
    // ...
}
```

**After:**
```cue
appConfig: {
    labels: {
        environment:   "prod"
        managed_by:    "argocd"
        "cost-center": "production-critical"
    }
    // ...
}
```

### CUE Unification Behavior

The env-level value takes precedence due to how `appConfig.labels` is defined in `app.cue`:

```cue
labels: defaultLabels & {
    // Allow environments to add or override labels
    ...
}
```

Unification result for prod:
```
defaultLabels (platform)          appConfig.labels (env)
{                                 {
  app: "example-app"                environment: "prod"
  deployment: "example-app"         managed_by: "argocd"
  "cost-center": "platform-shared"  "cost-center": "production-critical"
}                                 }
                    ↓
            Unified Result:
            {
              app: "example-app"
              deployment: "example-app"
              environment: "prod"
              managed_by: "argocd"
              "cost-center": "production-critical"  ← env wins
            }
```

## Verification Assertions

### Phase 3: Platform Default Promotion

After each environment merge:
```bash
assert_pod_label_equals "dev" "example-app" "cost-center" "platform-shared"
assert_pod_label_equals "stage" "example-app" "cost-center" "platform-shared"
assert_pod_label_equals "prod" "example-app" "cost-center" "platform-shared"
```

### Phase 4: Checkpoint

All environments match (proves UC-C1-like propagation):
```bash
assert_env_propagation "deployment" "example-app" \
    "{.spec.template.metadata.labels.cost-center}" \
    "platform-shared" \
    "dev" "stage" "prod"
```

### Phase 5: Override MR

```bash
assert_mr_contains_diff "$mr_iid" "env.cue" "production-critical"
```

### Phase 6: Final Verification (Divergent State)

```bash
# Dev and stage unchanged
assert_pod_label_equals "dev" "example-app" "cost-center" "platform-shared"
assert_pod_label_equals "stage" "example-app" "cost-center" "platform-shared"

# Prod has override
assert_pod_label_equals "prod" "example-app" "cost-center" "production-critical"
```

### MR Content Verification Matrix

| MR | Expected Content |
|----|------------------|
| Feature → dev | `services/core/app.cue` with `cost-center`, manifests with label |
| dev → stage | Manifests with `cost-center: platform-shared` |
| stage → prod | Manifests with `cost-center: platform-shared` |
| Override → prod | `env.cue` with `production-critical`, manifests updated |

## New Helper Function (Optional)

For clearer assertion of divergent state:

```bash
# Assert some environments have default, one has override
assert_env_override \
    "deployment" "example-app" \
    "{.spec.template.metadata.labels.cost-center}" \
    "platform-shared" "dev" "stage" \
    "production-critical" "prod"
```

## Files to Create/Modify

| File | Action |
|------|--------|
| `scripts/demo/demo-uc-c6-platform-env-override.sh` | Create - main demo script |
| `scripts/demo/lib/assertions.sh` | Possibly extend with `assert_env_override` |
| `docs/USE_CASES.md` | Update status after verification |

## Success Criteria

1. Demo script runs end-to-end without manual intervention
2. All assertions pass
3. GitLab MRs show correct diffs at each stage
4. ArgoCD syncs all changes successfully
5. Final state shows divergent label values across environments

## Related Use Cases

- **UC-C1:** Platform-wide label (prerequisite behavior, embedded in this demo)
- **UC-C5:** Platform default with app override (similar pattern, different layer)
- **UC-B4:** App default with env override (similar override concept at app layer)
