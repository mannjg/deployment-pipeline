# Jenkins Agent Image for CI/CD Pipeline
# =========================================
# Tools included:
#   - JDK 21 (Eclipse Temurin)
#   - Maven 3.9.6 (build tool)
#   - Docker CLI (container operations)
#   - CUE CLI (configuration language)
#   - kubectl (Kubernetes CLI)
#   - ArgoCD CLI (GitOps deployments)
#   - jq (JSON processing)
#   - yq (YAML processing)
#   - git, curl, wget (utilities)
#
# ENVIRONMENT-SPECIFIC CONFIGURATION:
#   The certs/internal-ca.crt file must be replaced with the CA certificate
#   for your environment's internal services (GitLab, Nexus, Docker registry).
#   This enables the agent to communicate with internal HTTPS services.

FROM jenkins/inbound-agent:latest-jdk21

USER root

# =============================================================================
# Base Dependencies
# =============================================================================
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    unzip \
    ca-certificates \
    gnupg \
    lsb-release \
    jq \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# Custom CA Certificate (for internal HTTPS services)
# NOTE: Replace certs/internal-ca.crt with your environment's CA certificate
# =============================================================================
COPY certs/internal-ca.crt /usr/local/share/ca-certificates/internal-ca.crt
RUN update-ca-certificates

# =============================================================================
# Maven
# =============================================================================
ARG MAVEN_VERSION=3.9.6
RUN mkdir -p /opt/maven && \
    cd /opt/maven && \
    wget -q https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz && \
    tar -xzf apache-maven-${MAVEN_VERSION}-bin.tar.gz && \
    rm apache-maven-${MAVEN_VERSION}-bin.tar.gz && \
    mv apache-maven-${MAVEN_VERSION} maven-${MAVEN_VERSION}

ENV MAVEN_HOME=/opt/maven/maven-${MAVEN_VERSION}
ENV PATH=$MAVEN_HOME/bin:$PATH

# =============================================================================
# Docker CLI
# =============================================================================
RUN mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
      $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    apt-get update && \
    apt-get install -y docker-ce-cli docker-buildx-plugin && \
    rm -rf /var/lib/apt/lists/*

# =============================================================================
# CUE CLI
# =============================================================================
ARG CUE_VERSION=v0.11.1
RUN cd /tmp && \
    wget -q https://github.com/cue-lang/cue/releases/download/${CUE_VERSION}/cue_${CUE_VERSION}_linux_amd64.tar.gz && \
    tar -xzf cue_${CUE_VERSION}_linux_amd64.tar.gz && \
    mv cue /usr/local/bin/cue && \
    chmod +x /usr/local/bin/cue && \
    rm cue_${CUE_VERSION}_linux_amd64.tar.gz

# =============================================================================
# kubectl
# =============================================================================
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" && \
    install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl && \
    rm kubectl

# =============================================================================
# ArgoCD CLI
# =============================================================================
ARG ARGOCD_VERSION=v2.13.3
RUN curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/${ARGOCD_VERSION}/argocd-linux-amd64 && \
    chmod +x /usr/local/bin/argocd

# =============================================================================
# yq (YAML processing)
# =============================================================================
ARG YQ_VERSION=v4.44.1
RUN wget -q https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64 -O /usr/local/bin/yq && \
    chmod +x /usr/local/bin/yq

# =============================================================================
# Setup Jenkins user
# =============================================================================
RUN mkdir -p /home/jenkins/.m2/repository && \
    chown -R jenkins:jenkins /home/jenkins/.m2

USER jenkins
WORKDIR /home/jenkins

# =============================================================================
# Verify installations
# =============================================================================
RUN echo "=== Installed Software ===" && \
    echo "Java:    $(java -version 2>&1 | head -1)" && \
    echo "Maven:   $(mvn --version | head -1)" && \
    echo "Docker:  $(docker --version)" && \
    echo "CUE:     $(cue version | head -1)" && \
    echo "kubectl: $(kubectl version --client 2>/dev/null | head -1)" && \
    echo "ArgoCD:  $(argocd version --client --short 2>/dev/null)" && \
    echo "jq:      $(jq --version)" && \
    echo "yq:      $(yq --version)"

CMD ["/usr/local/bin/jenkins-agent"]
