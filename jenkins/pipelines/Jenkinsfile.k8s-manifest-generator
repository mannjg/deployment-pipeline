/**
 * Jenkins Pipeline: K8s Manifest Generator
 *
 * Purpose: Automatically generate Kubernetes manifests from CUE configuration files
 * Trigger: Changes to CUE files in k8s-deployments repository (envs/, services/, k8s/)
 *
 * This ensures the pipeline owns manifest generation - never run generate-manifests.sh manually!
 */

pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        timeout(time: 10, unit: 'MINUTES')
    }

    triggers {
        // Poll SCM every 5 minutes for changes to CUE files
        pollSCM('H/5 * * * *')
    }

    environment {
        GIT_AUTHOR_NAME = 'Jenkins CI'
        GIT_AUTHOR_EMAIL = 'jenkins@deployment-pipeline.local'
        GIT_COMMITTER_NAME = 'Jenkins CI'
        GIT_COMMITTER_EMAIL = 'jenkins@deployment-pipeline.local'
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout the repository (Jenkins SCM plugin handles this)
                    checkout scm

                    // Configure git
                    sh """
                        git config user.name "${GIT_AUTHOR_NAME}"
                        git config user.email "${GIT_AUTHOR_EMAIL}"
                    """
                }
            }
        }

        stage('Check for CUE Changes') {
            steps {
                script {
                    // Check if there are any CUE file changes since last manifest generation
                    def cueChanged = sh(
                        script: """
                            # Check if manifests directory exists
                            if [ ! -d "manifests" ]; then
                                echo "true"
                                exit 0
                            fi

                            # Get last commit that modified manifests
                            LAST_MANIFEST_COMMIT=\$(git log -1 --format="%H" -- manifests/ 2>/dev/null || echo "")

                            if [ -z "\${LAST_MANIFEST_COMMIT}" ]; then
                                echo "true"
                                exit 0
                            fi

                            # Check if CUE files changed since last manifest commit
                            CUE_CHANGES=\$(git diff --name-only \${LAST_MANIFEST_COMMIT} HEAD | grep -E '\\.(cue|sh)\$')

                            if [ -n "\${CUE_CHANGES}" ]; then
                                echo "CUE files changed:"
                                echo "\${CUE_CHANGES}"
                                echo "true"
                            else
                                echo "false"
                            fi
                        """,
                        returnStdout: true
                    ).trim()

                    env.CUE_CHANGED = cueChanged.contains('true') ? 'true' : 'false'

                    if (env.CUE_CHANGED == 'false') {
                        echo "No CUE changes detected. Skipping manifest generation."
                        currentBuild.result = 'NOT_BUILT'
                        error("No CUE changes - skipping build")
                    }
                }
            }
        }

        stage('Generate Manifests') {
            steps {
                script {
                    sh """
                        # Run the manifest generation script
                        chmod +x scripts/generate-manifests.sh
                        ./scripts/generate-manifests.sh

                        # List generated manifests
                        echo "Generated manifests:"
                        find manifests -name '*.yaml' -type f
                    """
                }
            }
        }

        stage('Commit and Push') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'gitlab-credentials', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')]) {
                        sh """
                            # Check if there are changes to commit
                            if git diff --quiet manifests/; then
                                echo "No manifest changes to commit"
                                exit 0
                            fi

                            # Stage manifest changes
                            git add manifests/

                            # Create commit message with details
                            CUE_FILES=\$(git log -1 --format="" --name-only \${LAST_MANIFEST_COMMIT}..HEAD | grep '\\.cue\$' | tr '\\n' ' ')

                            COMMIT_MSG=\$(cat <<EOF
chore: regenerate manifests from CUE configuration

Automated manifest generation triggered by CUE changes.

CUE files modified:
\${CUE_FILES}

Generated by: Jenkins CI (k8s-manifest-generator)
Build: ${BUILD_URL}
EOF
)

                            # Commit the changes
                            git commit -m "\${COMMIT_MSG}"

                            # Push to origin
                            BRANCH=\${BRANCH_NAME:-main}
                            git push http://\${GIT_USERNAME}:\${GIT_PASSWORD}@gitlab.gitlab.svc.cluster.local/example/k8s-deployments.git HEAD:\${BRANCH}

                            echo "Successfully committed and pushed manifest changes to \${BRANCH}"
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Manifest generation completed successfully"
        }
        failure {
            echo "Manifest generation failed"
        }
        cleanup {
            cleanWs()
        }
    }
}
