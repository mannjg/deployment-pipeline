---
# Pipeline Infrastructure Configuration
# =====================================
# This ConfigMap provides environment-specific configuration for CI/CD pipelines.
# It is mounted as environment variables in Jenkins agent pods.
#
# DEPLOYMENT:
#   Use envsubst to substitute variables before applying:
#   envsubst < pipeline-config.yaml | kubectl apply -f -
#
# REQUIRED VARIABLES:
#   ${JENKINS_NAMESPACE} - Namespace for Jenkins resources (e.g., jenkins-alpha)
#   ${GITLAB_NAMESPACE}  - Namespace for GitLab resources (e.g., gitlab-alpha)
#   ${NEXUS_NAMESPACE}   - Namespace for Nexus resources (e.g., nexus-alpha)
#   ${ARGOCD_NAMESPACE}  - Namespace for ArgoCD resources (e.g., argocd-alpha)
#   ${GITLAB_HOST}       - GitLab hostname (e.g., gitlab-alpha.jmann.local)
#   ${JENKINS_HOST}      - Jenkins hostname (e.g., jenkins-alpha.jmann.local)
#   ${NEXUS_HOST}        - Nexus hostname (e.g., nexus-alpha.jmann.local)
#   ${ARGOCD_HOST}       - ArgoCD hostname (e.g., argocd-alpha.jmann.local)
#   ${DOCKER_REGISTRY}   - Container registry hostname (e.g., registry-dso.jmann.local)
#
# Naming convention (matches config/infra.env):
#   *_URL_INTERNAL  - Kubernetes service DNS names (pod-to-pod)
#   *_URL_EXTERNAL  - Ingress/external hostnames (user-facing)

apiVersion: v1
kind: ConfigMap
metadata:
  name: pipeline-config
  namespace: ${JENKINS_NAMESPACE}
  labels:
    app: jenkins
    component: pipeline-config
data:
  # ==========================================================================
  # GitLab Configuration
  # ==========================================================================
  GITLAB_URL_EXTERNAL: "https://${GITLAB_HOST}"
  GITLAB_URL_INTERNAL: "http://gitlab.${GITLAB_NAMESPACE}.svc.cluster.local"
  GITLAB_GROUP: "p2c"

  # Repository URLs (internal - for pod-to-pod communication)
  APP_REPO_URL: "http://gitlab.${GITLAB_NAMESPACE}.svc.cluster.local/p2c/example-app.git"
  DEPLOYMENTS_REPO_URL: "http://gitlab.${GITLAB_NAMESPACE}.svc.cluster.local/p2c/k8s-deployments.git"

  # ==========================================================================
  # Jenkins Configuration
  # ==========================================================================
  JENKINS_URL_EXTERNAL: "https://${JENKINS_HOST}"
  JENKINS_URL_INTERNAL: "http://jenkins.${JENKINS_NAMESPACE}.svc.cluster.local:8080"
  # Agent image must use external registry URL - kubelet uses node DNS, not cluster DNS
  # Path prefix separates image namespaces within the registry (e.g., p2c/)
  JENKINS_AGENT_IMAGE: "${DOCKER_REGISTRY}/${CONTAINER_REGISTRY_PATH_PREFIX}/jenkins-agent-custom:latest"
  CONTAINER_REGISTRY_PATH_PREFIX: "${CONTAINER_REGISTRY_PATH_PREFIX}"

  # ==========================================================================
  # Nexus / Docker Registry Configuration
  # ==========================================================================
  NEXUS_URL_EXTERNAL: "https://${NEXUS_HOST}"
  NEXUS_URL_INTERNAL: "http://nexus.${NEXUS_NAMESPACE}.svc.cluster.local:8081"
  DOCKER_REGISTRY_EXTERNAL: "${DOCKER_REGISTRY}"
  DOCKER_REGISTRY_INTERNAL: "nexus.${NEXUS_NAMESPACE}.svc.cluster.local:5000"

  # ==========================================================================
  # ArgoCD Configuration
  # ==========================================================================
  ARGOCD_URL_EXTERNAL: "https://${ARGOCD_HOST}"
  ARGOCD_URL_INTERNAL: "http://argocd-server.${ARGOCD_NAMESPACE}.svc.cluster.local"
  ARGOCD_SERVER: "argocd-server.${ARGOCD_NAMESPACE}.svc.cluster.local"
  ARGOCD_OPTS: "--insecure --grpc-web"

  # ==========================================================================
  # Git Configuration
  # ==========================================================================
  GIT_SSL_NO_VERIFY: "true"
