# MicroK8s Configuration

This directory contains MicroK8s-specific configuration and documentation.

## Files

- `kubeconfig` - Kubernetes config file (generated by install-microk8s.sh)
- `README.md` - This file

## Quick Commands

### Cluster Management

```bash
# Check status
microk8s status

# Start/stop
microk8s start
microk8s stop

# Enable/disable addons
microk8s enable dns storage ingress
microk8s disable ingress

# View enabled addons
microk8s status | grep enabled
```

### Kubectl Commands

```bash
# Use microk8s kubectl directly
microk8s kubectl get nodes
microk8s kubectl get pods --all-namespaces

# Or use alias (if configured)
kubectl get nodes
kubectl get pods -A
```

### Inspect and Debug

```bash
# Get detailed cluster info
microk8s inspect

# View logs
microk8s kubectl logs -n kube-system <pod-name>

# Shell into pod
microk8s kubectl exec -it -n <namespace> <pod-name> -- /bin/bash
```

### Cleanup

```bash
# Remove all deployments (keeps MicroK8s)
./scripts/teardown-all.sh

# Completely remove MicroK8s
sudo snap remove microk8s
```

## Troubleshooting

### MicroK8s not starting

```bash
# Check system resources
free -h
df -h

# View detailed status
sudo systemctl status snap.microk8s.daemon-kubelite

# Reset MicroK8s (WARNING: destroys all data)
microk8s reset
```

### DNS not working

```bash
# Check CoreDNS
microk8s kubectl get pods -n kube-system -l k8s-app=kube-dns

# Restart CoreDNS
microk8s kubectl rollout restart deployment/coredns -n kube-system

# Test DNS
microk8s kubectl run -it --rm debug --image=busybox --restart=Never -- nslookup kubernetes.default
```

### Ingress not working

```bash
# Check ingress controller
microk8s kubectl get pods -n ingress

# Check ingress resources
microk8s kubectl get ingress --all-namespaces

# Test ingress controller
curl http://localhost:80
```

## Resource Limits

MicroK8s runs on a single node, so resources are shared across all workloads:

- **Recommended**: 16GB RAM, 4 CPU cores, 100GB disk
- **Minimum**: 8GB RAM, 2 CPU cores, 50GB disk

Monitor resource usage:
```bash
microk8s kubectl top nodes
microk8s kubectl top pods --all-namespaces
```

## Addons Used

- **dns**: CoreDNS for service discovery
- **storage**: Default StorageClass for PersistentVolumeClaims
- **ingress**: NGINX Ingress Controller for HTTP routing

## Network Configuration

### Local Domain Resolution

The following domains are configured in `/etc/hosts`:
- `gitlab.local` → 127.0.0.1
- `jenkins.local` → 127.0.0.1
- `nexus.local` → 127.0.0.1
- `argocd.local` → 127.0.0.1

### Ingress Routing

All HTTP traffic on port 80 is routed by the NGINX Ingress Controller based on the `Host` header.

### Service Discovery

Inside the cluster, services can be accessed using:
- Short name: `<service-name>` (same namespace only)
- Qualified name: `<service-name>.<namespace>`
- Full name: `<service-name>.<namespace>.svc.cluster.local`

Example:
```bash
# From a pod in the jenkins namespace
curl http://gitlab.gitlab.svc.cluster.local
```

## Backup and Restore

### Backup

```bash
# Backup namespace resources
microk8s kubectl get all -n <namespace> -o yaml > backup-<namespace>.yaml

# Backup PVCs (data backup requires separate tool)
microk8s kubectl get pvc -n <namespace> -o yaml > backup-pvc-<namespace>.yaml
```

### Restore

```bash
# Restore from backup
microk8s kubectl apply -f backup-<namespace>.yaml
```

Note: PVC data is not backed up by this method. Use a proper backup solution for production data.
